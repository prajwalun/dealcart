# Reverse proxy for DealCart+ UI and API
:80 {
    # Health check endpoint for Docker
    route /caddy-health {
        respond 200
    }
    
    # API routes go to edge-gateway with explicit load balancing across replicas
    route /api/* {
        reverse_proxy {
            to edge-gateway-1:8080
            to edge-gateway-2:8080
            flush_interval -1
            health_uri /actuator/health
            health_interval 10s
            health_timeout 5s
            fail_duration 30s
            lb_try_duration 10s
            lb_try_interval 250ms
        }
    }
    
    # Actuator health check
    route /actuator/* {
        reverse_proxy {
            to edge-gateway-1:8080
            to edge-gateway-2:8080
            flush_interval -1
            health_uri /actuator/health
            health_interval 10s
            fail_duration 30s
            lb_try_duration 10s
            lb_try_interval 250ms
        }
    }
    
    # All other routes (UI) go to Next.js app
    reverse_proxy web-ui:3000
    
    # Enable logging
    log {
        output stdout
        format json
    }
    
    # Add server header
    header Server "DealCart+"
    
    # CORS headers
    header Access-Control-Allow-Origin *
    header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    header Access-Control-Allow-Headers *
}

